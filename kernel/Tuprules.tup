# Commands

ifeq (@(TARGET_ARCH),amd64)
	ASM_EXEC=x86_64-elf-g++
	CC_EXEC=x86_64-elf-g++
	CPP_EXEC=x86_64-elf-g++
	ARCHIVER=x86_64-elf-ar
	LINKER=x86_64-elf-g++
	OBJCOPY=x86_64-elf-objcopy
else
ifeq (@(TARGET_ARCH),i386)
	ASM_EXEC=i686-elf-g++
	CC_EXEC=i686-elf-g++
	CPP_EXEC=i686-elf-g++
	ARCHIVER=i686-elf-ar
	LINKER=i686-elf-g++
	OBJCOPY=i686-elf-objcopy
else
ifeq (@(TARGET_ARCH),rpi2)
	ASM_EXEC=arm-none-eabi-g++
	CC_EXEC=arm-none-eabi-g++
	CPP_EXEC=arm-none-eabi-g++
	ARCHIVER=arm-none-eabi-ar
	LINKER=arm-none-eabi-g++
	OBJCOPY=arm-none-eabi-objcopy
endif
endif
endif

# Flags

CC_FLAGS=$(CC_FLAGS) -DP_NAME_DECORATIVE=\"$(P_NAME_DECORATIVE)\" -DP_VERSION_DECORATIVE=\"$(P_VERSION_DECORATIVE)\"
CC_FLAGS=$(CC_FLAGS) -DARCH_FAMILY_$(TARGET_FAMILY)
CC_FLAGS=$(CC_FLAGS) -std=gnu++14 -Wall -Wextra -pedantic -O3 -fpic -ffreestanding -fno-exceptions -fno-rtti -nostdlib -g

OBJECTS=$(OBJECTS) common/*.o

LINK_FLAGS=$(LINK_FLAGS) -lgcc

ifeq (@(TARGET_ARCH),amd64)
	CC_FLAGS=$(CC_FLAGS) -DARCH_amd64
	CC_FLAGS=$(CC_FLAGS) -mcmodel=large -mno-red-zone -mno-mmx -mno-sse -mno-sse2 -z max-page-size=4096

	OBJECTS=$(OBJECTS) x86/*.o x86/amd64/*.o

	LINK_FLAGS=$(LINK_FLAGS)
	LINK_SCRIPT=x86/linker.ld
else
ifeq (@(TARGET_ARCH),i386)
	CC_FLAGS=$(CC_FLAGS) -DARCH_i386

	OBJECTS=$(OBJECTS) x86/*.o x86/i386/*.o

	LINK_FLAGS=$(LINK_FLAGS)
	LINK_SCRIPT=x86/linker.ld
else
ifeq (@(TARGET_ARCH),rpi2)
	CC_FLAGS=$(CC_FLAGS) -DARCH_rpi2
	CC_FLAGS=$(CC_FLAGS) -mcpu=arm1176jzf-s

	OBJECTS=$(OBJECTS) arm/*.o arm/rpi2/*.o

	LINK_FLAGS=$(LINK_FLAGS)
	LINK_SCRIPT=arm/rpi2/linker.ld
endif
endif
endif

# Compilation commands

!ASM      = |> $(ASM_EXEC) $(CC_FLAGS) -o %o -c %f                            |> %B.o
!CC       = |> $(CC_EXEC) $(CC_FLAGS) $(INCLUDES) -o %o -c %f                 |> %B.o
!CPP      = |> $(CPP_EXEC) $(CC_FLAGS) $(INCLUDES) -o %o -c %f                |> %B.o
!LINKER   = |> $(LINKER) $(CC_FLAGS) -T $(LINK_SCRIPT) $(LINK_FLAGS) -o %o %f |> %B
!ARCHIVER = |> $(ARCHIVER) rcs %o %f                                          |> %B.a
!OBJCOPY  = |> $(OBJCOPY) $(OBJCOPY_FLAGS) %f %o                              |> %B.o
